
    * Ok, castling seems to work somewhat. Still need to check legality
      of castling (probably need an attack matrix and check if squares king
      moves through are attacked)

    * Castling is broken because moving a rook discards your ability to
      castle on all sides, and the castle state is not restored on undo

    * do sorting with qsort(), and then remove dupes in a single traversal

    * Ok, pinning pieces is probably fixed (at a subsequent performance loss)

    * Pinning pieces to the king is probably broken
